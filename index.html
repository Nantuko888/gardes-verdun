<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>DEMANDES DE GARDES CS VERDUN</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f3f3;
      font-family: Arial, sans-serif;
      user-select: none;
    }

    /* HEADER BANDEAU */
    #header {
      background: #0c1f45;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 16px;
      padding: 12px 8px;
      font-size: 1.6em;
      font-weight: bold;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
    }

    /* CONTROLS */
    #controls {
      max-width: 1200px;
      margin: 10px auto;
      padding: 0 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }
    #controls-left,
    #controls-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 8px;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid #666;
      background: #ffffff;
      cursor: pointer;
      font-size: 0.9em;
    }
    .btn.active {
      background: #ffd659;
      border-color: #e2b000;
      font-weight: bold;
    }
    #current-agent-select {
      padding: 4px;
      font-size: 0.9em;
    }

    /* Onglets admin (en haut, √† c√¥t√© d'Administrateur) */
    #admin-tabs {
      display: none;
      gap: 6px;
      align-items: center;
    }

    /* Badge d'√©quipe */
    #team-badge {
      display: none;
      padding: 3px 10px;
      border-radius: 12px;
      font-size: 0.8em;
      font-weight: bold;
      border: 1px solid #444;
    }

    /* MOIS / ANN√âE */
    #month-year {
      max-width: 1200px;
      margin: 0 auto 12px auto;
      padding: 0 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    #select-month {
      width: 130px;
    }
    #select-year {
      width: 80px;
    }

    /* WRAPPER TABLE */
    .wrapper {
      max-width: 1200px;
      margin: 0 auto;
      background: #ffffff;
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
      overflow-x: auto;
      overflow-y: hidden;
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      /* on laisse le tableau s‚Äô√©taler et on scrolle horizontalement */
      min-width: 3200px;
      table-layout: fixed;
    }
    th,
    td {
      border: 1px solid #444;
      padding: 4px;
      font-size: 0.82em;
      text-align: center;
      background: #ffffff;
      white-space: nowrap;
      /* chaque jour a une largeur minimale pour voir le texte */
      min-width: 95px;
    }

    /* les selects occupent toute la case */
    td select {
      width: 100%;
      box-sizing: border-box;
    }

    /* COLONNE AGENTS */
    .name-header {
      position: sticky;
      left: 0;
      z-index: 50;
      background: rgb(246, 64, 77); /* rouge demand√© */
      color: #ffffff;
      min-width: 220px;
    }
    .name-cell {
      position: sticky;
      left: 0;
      z-index: 40;
      background: #e0e0e0;
      text-align: left;
      padding-left: 8px;
      min-width: 220px;
      box-shadow: 4px 0 4px rgba(0, 0, 0, 0.25); /* masque ce qui passe derri√®re */
    }
    .team-1 {
      background: #9dc3e6 !important; /* bleu √©quipe 1 */
    }
    .team-2 {
      background: #ffe699 !important; /* jaune √©quipe 2 */
    }

    /* WEEK-END / F√âRI√âS */
    .weekend {
      background: #dbe6ff !important;
    }
    .holiday {
      background: #c8f2c8 !important;
    }

    /* STICKY LIGNES EN PAYSAGE */
    @media (orientation: landscape) {
      .weeks-row th {
        position: sticky;
        top: 0;
        z-index: 30;
      }
      .dates-row th {
        position: sticky;
        top: 26px;
        z-index: 30;
      }
      .days-row th {
        position: sticky;
        top: 52px;
        z-index: 30;
      }
    }

    /* PARAM√àTRES ADMIN */
    #parametres-panel {
      max-width: 1200px;
      margin: 14px auto 20px auto;
      padding: 14px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
      display: none;
    }
    #parametres-panel h2 {
      margin-top: 0;
    }
    .table-admin {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .table-admin th,
    .table-admin td {
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 0.85em;
      text-align: left;
    }
    .small-input {
      width: 80px;
    }
    .full-input {
      width: 100%;
    }
    .eye-btn {
      padding: 3px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div id="header">
    DEMANDES DE GARDES CS VERDUN
  </div>

  <!-- CONTROLS -->
  <div id="controls">
    <div id="controls-left">
      <span>Mode :</span>
      <button id="btn-mode-agent" class="btn active">Agent</button>
      <button id="btn-mode-admin" class="btn">Administrateur</button>

      <!-- Onglets admin (uniquement visibles en mode Admin) -->
      <div id="admin-tabs">
        <button id="btn-admin-agents" class="btn active">Agents</button>
        <button id="btn-admin-interd" class="btn">Interdictions</button>
      </div>

      <span id="block-agent-select">
        Je suis :
        <select id="current-agent-select">
          <option value="">-- choisir agent --</option>
        </select>
      </span>

      <!-- Badge d'√©quipe -->
      <span id="team-badge"></span>

      <button id="btn-change-pwd" class="btn" style="display: none">
        Changer mon mot de passe
      </button>
    </div>

    <div id="controls-right">
      <button id="btn-change-admin-pwd" class="btn" style="display: none">
        Changer mot de passe admin
      </button>
    </div>
  </div>

  <!-- MOIS / ANN√âE -->
  <div id="month-year">
    <span>Mois :</span>
    <select id="select-month"></select>
    <span>Ann√©e :</span>
    <select id="select-year"></select>
  </div>

  <!-- TABLE PLANNING -->
  <div class="wrapper">
    <table id="planning"></table>
  </div>

  <!-- PARAM√àTRES ADMIN -->
  <div id="parametres-panel">
    <h2>‚öô Param√®tres administrateur</h2>

    <!-- Panneau Agents -->
    <div id="panel-agents">
      <h3>Agents</h3>
      <p>R√©glez la visibilit√©, l'√©quipe, le quota et les mots de passe provisoires.</p>
      <table id="table-param-agents" class="table-admin">
        <tr>
          <th>Agent</th>
          <th>Afficher</th>
          <th>√âquipe</th>
          <th>Quota (gardes)</th>
          <th>Mot de passe provisoire</th>
          <th>R√©initialiser mot de passe</th>
        </tr>
      </table>
    </div>

    <!-- Panneau Interdictions -->
    <div id="panel-interdictions" style="display: none">
      <h3>Interdictions</h3>
      <p>
        Les jours ajout√©s ici seront color√©s et bloqu√©s pour l'√©quipe concern√©e
        (ou pour tous en cas de man≈ìuvre commune ou autre interdiction
        g√©n√©rale).
      </p>
      <table id="table-interdictions" class="table-admin">
        <tr>
          <th>Date</th>
          <th>√âquipe</th>
          <th>Type</th>
          <th>Note (si "Autre")</th>
          <th>Supprimer</th>
        </tr>
      </table>

      <button id="btn-add-interdiction" class="btn">
        + Ajouter une interdiction
      </button>
    </div>
  </div>

  <script>
    /* ==============================
       DONN√âES DE BASE
       ============================== */
    const AGENTS = [
      "BAMME M",
      "BAROTTE C",
      "BAUR B",
      "CHRISTAL E",
      "CHRISTAL M",
      "GAFFARD R",
      "JOSEPH J",
      "LALEEUW F",
      "MICHEL M",
      "ROGIE F",
      "SABOURET BAROTTE M",
      "SENECHAL B",
      "STELLATO V",
      "TRONTIN C",
      "VENANTE A",
      "VENANTE P",
      "WALLARIN H"
    ];

    const CHOIX = [
      "",
      "Garde 24",
      "Garde 12 J",
      "Garde 12 N",
      "1/2 G matin",
      "1/2 G apr√®s-midi"
    ];

    const MONTHS = [
      { value: 0, label: "Janvier" },
      { value: 1, label: "F√©vrier" },
      { value: 2, label: "Mars" },
      { value: 3, label: "Avril" },
      { value: 4, label: "Mai" },
      { value: 5, label: "Juin" },
      { value: 6, label: "Juillet" },
      { value: 7, label: "Ao√ªt" },
      { value: 8, label: "Septembre" },
      { value: 9, label: "Octobre" },
      { value: 10, label: "Novembre" },
      { value: 11, label: "D√©cembre" }
    ];
    const YEARS = [2026, 2027, 2028];

    function getMonthId(year, monthIndex) {
      return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
    }

    /* Jours f√©ri√©s (exemple ‚Äì √† compl√©ter si besoin) */
    const HOLIDAYS = new Set([
      "2026-01-01"
    ]);

    /* ==============================
       MOT DE PASSE ADMIN
       ============================== */
    let adminPassword = "1122";
    const ADMIN_PWD_KEY = "planning_admin_password_v1";

    function loadAdminPassword() {
      try {
        const raw = localStorage.getItem(ADMIN_PWD_KEY);
        if (raw) adminPassword = raw;
      } catch (e) {}
    }
    function saveAdminPassword() {
      localStorage.setItem(ADMIN_PWD_KEY, adminPassword);
    }

    /* ==============================
       MOTS DE PASSE AGENTS
       ============================== */
    let agentPasswords = {};
    let agentPasswordDefaults = {};
    const PASSWORDS_KEY = "planning_passwords_v4";

    function loadPasswords() {
      try {
        const raw = localStorage.getItem(PASSWORDS_KEY);
        if (raw) {
          const saved = JSON.parse(raw);
          agentPasswords = saved.agentPasswords || {};
          agentPasswordDefaults = saved.agentPasswordDefaults || {};
        }
      } catch (e) {}
    }
    function savePasswords() {
      localStorage.setItem(
        PASSWORDS_KEY,
        JSON.stringify({ agentPasswords, agentPasswordDefaults })
      );
    }

    function initDefaultPasswords() {
      AGENTS.forEach(agent => {
        if (!agentPasswordDefaults[agent]) {
          agentPasswordDefaults[agent] = "0000";
        }
        if (!agentPasswords[agent]) {
          agentPasswords[agent] = agentPasswordDefaults[agent];
        }
      });
    }

    /* ==============================
       QUOTAS
       ============================== */
    let quotas = {
      "VENANTE P": 2,
      "LALEEUW F": 3,
      "BAROTTE C": 2,
      "VENANTE A": 2,
      "CHRISTAL M": 2,
      "CHRISTAL E": 2,
      "BAUR B": 2,
      "MICHEL M": 2,
      "ROGIE F": 2,
      "SENECHAL B": 2,
      "WALLARIN H": 2,
      "STELLATO V": 2,
      "TRONTIN C": 2,
      "GAFFARD R": 2,
      "JOSEPH J": 2,
      "BAMME M": 2
    };
    const QUOTAS_KEY = "planning_consenvoye_quotas_v5";

    function loadQuotas() {
      try {
        const raw = localStorage.getItem(QUOTAS_KEY);
        if (raw) {
          const saved = JSON.parse(raw);
          quotas = { ...quotas, ...saved };
        }
      } catch (e) {}
    }
    function saveQuotas() {
      localStorage.setItem(QUOTAS_KEY, JSON.stringify(quotas));
    }

    /* ==============================
       EQUIPES
       ============================== */
    let teams = {}; // "1" / "2" / ""
    const TEAMS_KEY = "planning_consenvoye_teams_v1";

    function loadTeams() {
      try {
        const raw = localStorage.getItem(TEAMS_KEY);
        if (raw) teams = JSON.parse(raw);
      } catch (e) {}
    }
    function saveTeams() {
      localStorage.setItem(TEAMS_KEY, JSON.stringify(teams));
    }

    /* ==============================
       VISIBILIT√â AGENTS
       ============================== */
    let agentVisible = {};
    const VIS_KEY = "planning_consenvoye_visible_v1";

    function loadAgentVisible() {
      try {
        const raw = localStorage.getItem(VIS_KEY);
        if (raw) agentVisible = JSON.parse(raw);
      } catch (e) {}
    }
    function saveAgentVisible() {
      localStorage.setItem(VIS_KEY, JSON.stringify(agentVisible));
    }

    /* ==============================
       INTERDICTIONS
       ============================== */
    /*
      {
        date: "YYYY-MM-DD",
        team: "1" | "2" | "TOUS",
        noteType: "EQ1" | "EQ2" | "COMMUNE" | "AUTRE",
        customNote: ""
      }
    */
    let interdictions = [];
    const INTERD_KEY = "planning_consenvoye_interd_v2";

    function normalizeInterdiction(it) {
      if (!it.team) it.team = "1";
      if (!it.noteType) it.noteType = "EQ1";
      if (!it.customNote) it.customNote = "";
      if (it.note && !it.customNote && it.noteType === "AUTRE") {
        it.customNote = it.note;
      }
      return it;
    }
    function loadInterdictions() {
      try {
        const raw = localStorage.getItem(INTERD_KEY);
        if (raw) {
          const arr = JSON.parse(raw);
          interdictions = arr.map(normalizeInterdiction);
        }
      } catch (e) {}
    }
    function saveInterdictions() {
      localStorage.setItem(INTERD_KEY, JSON.stringify(interdictions));
    }

    function getInterdictionForDate(dateISO) {
      return interdictions.filter(it => it.date === dateISO);
    }

    function getInterdictionsForAgent(dateISO, agent) {
      const its = getInterdictionForDate(dateISO);
      if (!its.length) return [];

      const team = teams[agent] || "";

      // Man≈ìuvre Commune ou Autre => bloque tout le monde
      const communeOrAutre = its.filter(
        it => it.noteType === "COMMUNE" || it.noteType === "AUTRE"
      );
      if (communeOrAutre.length) return communeOrAutre;

      // Sinon : blocage par √©quipe ou TOUS
      return its.filter(it => it.team === "TOUS" || (team && it.team === team));
    }

    function getInterdictionReasonText(it) {
      switch (it.noteType) {
        case "EQ1":
          return "Man≈ìuvre √âquipe 1";
        case "EQ2":
          return "Man≈ìuvre √âquipe 2";
        case "COMMUNE":
          return "Man≈ìuvre Commune";
        case "AUTRE":
          return it.customNote || "Autre";
        default:
          return "Interdiction";
      }
    }

    function getInterdictionColorForDate(dateISO) {
      const its = getInterdictionForDate(dateISO);
      if (!its.length) return null;

      if (its.some(it => it.noteType === "COMMUNE" || it.noteType === "AUTRE")) {
        return "#f4b184"; // tous
      }
      if (its.some(it => it.team === "1")) return "#9dc3e6";
      if (its.some(it => it.team === "2")) return "#ffe699";
      if (its.some(it => it.team === "TOUS")) return "#f4b184";
      return null;
    }

    /* ==============================
       DONN√âES PLANNING
       ============================== */
    let data = {};
    const DATA_KEY = "planning_consenvoye_v6";

    function loadData() {
      try {
        const raw = localStorage.getItem(DATA_KEY);
        if (raw) data = JSON.parse(raw);
        else data = {};
      } catch (e) {
        data = {};
      }
    }
    function saveData() {
      localStorage.setItem(DATA_KEY, JSON.stringify(data));
    }

    /* ==============================
       VARIABLES COURANTES
       ============================== */
    let currentMode = "agent";
    let currentAgent = "";
    let currentYear = YEARS[0];
    let currentMonthIndex = 0;
    let currentMonthId = getMonthId(currentYear, currentMonthIndex);

    /* ==============================
       VALEUR GARDE
       ============================== */
    function valeurGarde(val) {
      switch (val) {
        case "Garde 24":
          return 2;
        case "Garde 12 J":
          return 1;
        case "Garde 12 N":
          return 1;
        case "1/2 G matin":
          return 0.5;
        case "1/2 G apr√®s-midi":
          return 0.5;
        default:
          return 0;
      }
    }

    function totalGardes(agent, moisID) {
      let total = 0;
      if (!data[moisID]) return 0;
      for (const date in data[moisID]) {
        const tab = data[moisID][date];
        for (const nom in tab) {
          if (nom === agent) total += valeurGarde(tab[nom]);
        }
      }
      return total;
    }

    /* ==============================
       NUM√âRO DE SEMAINE
       ============================== */
    function getISOWeek(date) {
      const tmp = new Date(
        Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())
      );
      const dayNum = tmp.getUTCDay() || 7;
      tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(), 0, 1));
      const weekNo = Math.ceil(((tmp - yearStart) / 86400000 + 1) / 7);
      return weekNo;
    }

    /* ==============================
       DROITS DE MODIFICATION
       ============================== */
    function checkCanEdit(agent) {
      if (currentMode === "admin") return null;
      if (!currentAgent) {
        return "Veuillez d'abord vous identifier en s√©lectionnant votre nom.";
      }
      if (agent !== currentAgent) {
        return "Vous ne pouvez modifier que votre propre ligne.";
      }
      return null;
    }

    /* ==============================
       IMPOSSIBILIT√âS
       ============================== */
    function getImpossibleReason(moisID, dateISO, agent, oldValue, newValue) {
      const day = data[moisID][dateISO] || {};

      // Interdictions
      if (newValue !== "") {
        const its = getInterdictionsForAgent(dateISO, agent);
        if (its.length) {
          const reasonText = getInterdictionReasonText(its[0]);
          return (
            "Jour interdit pour votre √©quipe. Raison : " + reasonText + "."
          );
        }
      }

      // Autre agent en 24h
      for (const other in day) {
        if (day[other] === "Garde 24" && other !== agent && newValue !== "") {
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
        }
      }

      // On veut mettre 24h alors qu'il y a d√©j√† quelque chose
      if (newValue === "Garde 24") {
        for (const other in day) {
          if (day[other] !== "" && other !== agent) {
            return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
          }
        }
      }

      // Incompatibilit√©s
      for (const other in day) {
        const val = day[other];
        if (other === agent) continue;

        if (newValue === "Garde 12 J" && val === "Garde 12 J")
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
        if (newValue === "Garde 12 N" && val === "Garde 12 N")
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
        if (newValue === "1/2 G matin" && val === "1/2 G matin")
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
        if (newValue === "1/2 G apr√®s-midi" && val === "1/2 G apr√®s-midi")
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";

        if (
          newValue === "Garde 12 J" &&
          (val === "1/2 G matin" || val === "1/2 G apr√®s-midi")
        )
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";

        if (
          val === "Garde 12 J" &&
          (newValue === "1/2 G matin" || newValue === "1/2 G apr√®s-midi")
        )
          return "Ce cr√©neau est impossible. D√©j√† un agent en place.";
      }

      // Quota
      const quota = quotas[agent] ?? 0;
      const total = totalGardes(agent, moisID);
      const ancien = valeurGarde(oldValue);
      const ajout = valeurGarde(newValue);
      const totalSansCase = total - ancien;

      if (totalSansCase + ajout > quota) {
        return "Ce cr√©neau est impossible. Quota mensuel atteint.";
      }

      return null;
    }

    /* ==============================
       STYLE DES CELLULES
       ============================== */
    function applyCellStyle(value, td, select) {
      // On laisse weekend/f√©ri√©/interdiction g√©rer le fond si vide
      td.style.backgroundColor = "";
      select.style.backgroundColor = "#ffffff";
      select.style.color = "#000000";
      select.style.fontWeight = "normal";

      if (!value) {
        return;
      }

      let bg = "";
      let textColor = "#000000";

      switch (value) {
        case "Garde 24":
          bg = "#ffd39b"; // orange clair
          break;
        case "Garde 12 J":
          bg = "#40e0d0"; // turquoise
          break;
        case "Garde 12 N":
          bg = "#d9d9d9"; // gris pastel
          break;
        case "1/2 G matin":
          bg = "#e6ccff"; // violet clair
          break;
        case "1/2 G apr√®s-midi":
          bg = "#006a4e"; // vert bouteille
          textColor = "#ffffff";
          break;
      }

      td.style.backgroundColor = bg;
      select.style.backgroundColor = bg;
      select.style.color = textColor;
      select.style.fontWeight = "bold";
    }

    /* ==============================
       DATES EN ROUGE SI GARDE
       ============================== */
    function updateDayHeaders() {
      const table = document.getElementById("planning");
      const headerRow = table.querySelector("tr.dates-row");
      if (!headerRow) return;

      const moisID = currentMonthId;
      headerRow.querySelectorAll("th[data-date]").forEach(th => {
        const dateISO = th.getAttribute("data-date");
        const dayData = (data[moisID] && data[moisID][dateISO]) || {};
        let used = false;
        for (const a in dayData) {
          if (dayData[a]) used = true;
        }
        th.style.color = used ? "red" : "black";
      });
    }

    /* ==============================
       COLORATION INTERDICTIONS COLONNE
       ============================== */
    function applyInterdictionStyles() {
      const table = document.getElementById("planning");
      const datesRow = table.querySelector("tr.dates-row");
      const daysRow = table.querySelector("tr.days-row");
      const emptyRow = table.querySelector("tr.empty-row");
      if (!datesRow || !daysRow || !emptyRow) return;

      const dateHeaders = Array.from(datesRow.querySelectorAll("th[data-date]"));
      const allRows = table.rows;

      dateHeaders.forEach((th, index) => {
        const dateISO = th.getAttribute("data-date");
        const color = getInterdictionColorForDate(dateISO);
        if (!color) return;

        // date
        th.style.backgroundColor = color;

        // jour (ligne jours) : m√™me index (pas de colonne AGENT ici)
        if (daysRow.cells[index]) {
          daysRow.cells[index].style.backgroundColor = color;
        }

        // ligne vide
        if (emptyRow.cells[index]) {
          emptyRow.cells[index].style.backgroundColor = color;
        }

        // lignes agents : +1 (colonne 0 = AGENT)
        for (let r = 4; r < allRows.length; r++) {
          const row = allRows[r];
          const cell = row.cells[index + 1];
          if (!cell) continue;
          const sel = cell.querySelector("select");
          if (sel && sel.value) continue; // laisse la couleur de garde
          cell.style.backgroundColor = color;
        }
      });
    }

    /* ==============================
       CONSTRUCTION DU MOIS
       ============================== */
    function buildMonth(year, monthIndex) {
      currentYear = year;
      currentMonthIndex = monthIndex;
      currentMonthId = getMonthId(year, monthIndex);

      const table = document.getElementById("planning");
      table.innerHTML = "";

      const nbDays = new Date(year, monthIndex + 1, 0).getDate();
      if (!data[currentMonthId]) data[currentMonthId] = {};

      // num√©ros de semaine
      const weekNumbers = [];
      for (let d = 1; d <= nbDays; d++) {
        const dateObj = new Date(year, monthIndex, d);
        weekNumbers.push(getISOWeek(dateObj));
      }

      // Ligne semaines + AGENTS
      const trWeeks = document.createElement("tr");
      trWeeks.className = "weeks-row";

      const thName = document.createElement("th");
      thName.rowSpan = 4;
      thName.textContent = "AGENTS";
      thName.className = "name-header";
      trWeeks.appendChild(thName);

      let i = 0;
      while (i < nbDays) {
        const currentWeek = weekNumbers[i];
        let span = 1;
        while (i + span < nbDays && weekNumbers[i + span] === currentWeek) {
          span++;
        }
        const thWeek = document.createElement("th");
        thWeek.colSpan = span;
        thWeek.textContent = "Semaine " + currentWeek; // <<< Semaine 1, 2, 3...
        trWeeks.appendChild(thWeek);
        i += span;
      }
      table.appendChild(trWeeks);

      // Ligne dates
      const trDates = document.createElement("tr");
      trDates.className = "dates-row";
      for (let d = 1; d <= nbDays; d++) {
        const th = document.createElement("th");
        const dateISO = `${year}-${String(monthIndex + 1).padStart(
          2,
          "0"
        )}-${String(d).padStart(2, "0")}`;
        const dayObj = new Date(year, monthIndex, d);

        th.textContent = d.toString().padStart(2, "0");
        th.setAttribute("data-date", dateISO);

        if (dayObj.getDay() === 0 || dayObj.getDay() === 6)
          th.classList.add("weekend");
        if (HOLIDAYS.has(dateISO)) th.classList.add("holiday");

        trDates.appendChild(th);
      }
      table.appendChild(trDates);

      // Ligne jours
      const trJours = document.createElement("tr");
      trJours.className = "days-row";
      for (let d = 1; d <= nbDays; d++) {
        const th = document.createElement("th");
        const dateISO = `${year}-${String(monthIndex + 1).padStart(
          2,
          "0"
        )}-${String(d).padStart(2, "0")}`;
        const dayObj = new Date(year, monthIndex, d);

        th.textContent = dayObj.toLocaleDateString("fr-FR", {
          weekday: "short"
        });

        if (dayObj.getDay() === 0 || dayObj.getDay() === 6)
          th.classList.add("weekend");
        if (HOLIDAYS.has(dateISO)) th.classList.add("holiday");

        trJours.appendChild(th);
      }
      table.appendChild(trJours);

      // Ligne vide
      const trVide = document.createElement("tr");
      trVide.className = "empty-row";
      for (let d = 1; d <= nbDays; d++) {
        trVide.appendChild(document.createElement("th"));
      }
      table.appendChild(trVide);

      // Lignes agents visibles
      AGENTS.forEach(agent => {
        const visible = agentVisible[agent];
        if (visible === false) return;

        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "name-cell";

        const team = teams[agent] || "";
        if (team === "1") tdName.classList.add("team-1");
        else if (team === "2") tdName.classList.add("team-2");

        tdName.textContent = agent;
        tr.appendChild(tdName);

        for (let d = 1; d <= nbDays; d++) {
          const td = document.createElement("td");
          const dateISO = `${year}-${String(monthIndex + 1).padStart(
            2,
            "0"
          )}-${String(d).padStart(2, "0")}`;
          const dayObj = new Date(year, monthIndex, d);

          if (dayObj.getDay() === 0 || dayObj.getDay() === 6)
            td.classList.add("weekend");
          if (HOLIDAYS.has(dateISO)) td.classList.add("holiday");

          const select = document.createElement("select");
          CHOIX.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            select.appendChild(o);
          });

          if (!data[currentMonthId][dateISO])
            data[currentMonthId][dateISO] = {};
          if (!data[currentMonthId][dateISO][agent])
            data[currentMonthId][dateISO][agent] = "";

          select.value = data[currentMonthId][dateISO][agent];
          applyCellStyle(select.value, td, select);

          select.addEventListener("change", () => {
            const oldValue = data[currentMonthId][dateISO][agent];
            const newValue = select.value;
            if (newValue === oldValue) return;

            const permMsg = checkCanEdit(agent);
            if (permMsg) {
              alert(permMsg);
              select.value = oldValue;
              return;
            }

            const reason = getImpossibleReason(
              currentMonthId,
              dateISO,
              agent,
              oldValue,
              newValue
            );
            if (reason) {
              alert(reason);
              select.value = oldValue;
              return;
            }

            data[currentMonthId][dateISO][agent] = newValue;
            applyCellStyle(newValue, td, select);
            saveData();
            updateDayHeaders();
          });

          td.appendChild(select);
          tr.appendChild(td);
        }

        table.appendChild(tr);
      });

      updateDayHeaders();
      applyInterdictionStyles();
      if (currentMode === "admin") buildParametresTables();
    }

    /* ==============================
       BADGE D'√âQUIPE
       ============================== */
    function updateTeamBadge() {
      const badge = document.getElementById("team-badge");
      if (!badge) return;

      if (!currentAgent) {
        badge.style.display = "none";
        return;
      }

      const t = teams[currentAgent] || "";
      let text = "";
      let bg = "";
      let color = "#000";

      if (t === "1") {
        text = "√âQUIPE 1";
        bg = "#9dc3e6";
      } else if (t === "2") {
        text = "√âQUIPE 2";
        bg = "#ffe699";
      } else {
        text = "AUCUNE √âQUIPE";
        bg = "#e0e0e0";
      }

      badge.textContent = text;
      badge.style.backgroundColor = bg;
      badge.style.color = color;
      badge.style.display = "inline-block";
    }

    /* ==============================
       CONNEXION AGENT
       ============================== */
    function askAgentPassword(agent) {
      const pwd = prompt("Mot de passe pour " + agent + " :");
      if (pwd === null) return false;
      if (pwd === agentPasswords[agent]) {
        currentAgent = agent;
        document.getElementById("btn-change-pwd").style.display =
          "inline-block";
        updateTeamBadge();
        return true;
      }
      alert("Mot de passe incorrect.");
      return false;
    }

    /* ==============================
       MODES AGENT / ADMIN
       ============================== */
    function setModeAgent() {
      currentMode = "agent";
      currentAgent = "";
      document.getElementById("btn-mode-agent").classList.add("active");
      document.getElementById("btn-mode-admin").classList.remove("active");

      document.getElementById("parametres-panel").style.display = "none";
      document.getElementById("btn-change-admin-pwd").style.display = "none";
      document.getElementById("btn-change-pwd").style.display = "none";
      document.getElementById("block-agent-select").style.display =
        "inline-block";
      document.getElementById("admin-tabs").style.display = "none";

      const selAgent = document.getElementById("current-agent-select");
      selAgent.value = "";
      updateTeamBadge();

      buildMonth(currentYear, currentMonthIndex);
    }

    function setModeAdmin() {
      const pwd = prompt("Mot de passe Administrateur :");
      if (pwd !== adminPassword) {
        alert("Mot de passe incorrect.");
        return;
      }

      currentMode = "admin";
      currentAgent = "";

      document.getElementById("btn-mode-agent").classList.remove("active");
      document.getElementById("btn-mode-admin").classList.add("active");

      document.getElementById("parametres-panel").style.display = "block";
      document.getElementById("btn-change-admin-pwd").style.display =
        "inline-block";
      document.getElementById("btn-change-pwd").style.display = "none";

      // en admin, tu m'as demand√© de SUPPRIMER "Je suis : choisir agent"
      document.getElementById("block-agent-select").style.display = "none";
      document.getElementById("team-badge").style.display = "none";

      // onglets admin visibles
      document.getElementById("admin-tabs").style.display = "flex";
      setAdminTab("agents");

      const selAgent = document.getElementById("current-agent-select");
      selAgent.value = "";
      updateTeamBadge();

      buildParametresTables();
      buildMonth(currentYear, currentMonthIndex);
    }

    /* ==============================
       PARAM√àTRES ADMIN : TABLES
       ============================== */
    function buildParametresTables() {
      buildParamAgentsTable();
      buildInterdictionsTable();
    }

    function buildParamAgentsTable() {
      const table = document.getElementById("table-param-agents");
      table.innerHTML = `
        <tr>
          <th>Agent</th>
          <th>Afficher</th>
          <th>√âquipe</th>
          <th>Quota (gardes)</th>
          <th>Mot de passe provisoire</th>
          <th>R√©initialiser mot de passe</th>
        </tr>
      `;

      AGENTS.forEach(agent => {
        const tr = document.createElement("tr");

        // Nom
        const tdName = document.createElement("td");
        tdName.textContent = agent;
        tr.appendChild(tdName);

        // Visibilit√©
        const tdVis = document.createElement("td");
        const btnEye = document.createElement("button");
        btnEye.className = "eye-btn";

        function refreshEye() {
          const visible = agentVisible[agent] !== false;
          btnEye.textContent = visible ? "üëÅÔ∏è" : "üôà";
        }
        refreshEye();

        btnEye.addEventListener("click", () => {
          const visible = agentVisible[agent] !== false;
          agentVisible[agent] = !visible;
          saveAgentVisible();
          refreshEye();
          buildMonth(currentYear, currentMonthIndex);
        });

        tdVis.appendChild(btnEye);
        tr.appendChild(tdVis);

        // √âquipe
        const tdTeam = document.createElement("td");
        const selTeam = document.createElement("select");
        ["", "1", "2"].forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v ? "√âquipe " + v : "--";
          selTeam.appendChild(o);
        });
        selTeam.value = teams[agent] || "";
        selTeam.addEventListener("change", () => {
          teams[agent] = selTeam.value;
          saveTeams();
          buildMonth(currentYear, currentMonthIndex);
          if (agent === currentAgent) {
            updateTeamBadge();
          }
        });
        tdTeam.appendChild(selTeam);
        tr.appendChild(tdTeam);

        // Quota
        const tdQuota = document.createElement("td");
        const inpQuota = document.createElement("input");
        inpQuota.type = "number";
        inpQuota.min = "0";
        inpQuota.step = "0.5";
        inpQuota.value = quotas[agent] ?? 0;
        inpQuota.className = "small-input";
        inpQuota.addEventListener("change", () => {
          quotas[agent] = parseFloat(inpQuota.value) || 0;
          saveQuotas();
        });
        tdQuota.appendChild(inpQuota);
        tr.appendChild(tdQuota);

        // Mot de passe provisoire
        const tdPwdDef = document.createElement("td");
        const inpDef = document.createElement("input");
        inpDef.type = "text";
        inpDef.value = agentPasswordDefaults[agent] || "0000";
        inpDef.className = "small-input";
        inpDef.addEventListener("change", () => {
          agentPasswordDefaults[agent] = inpDef.value || "0000";
          savePasswords();
        });
        tdPwdDef.appendChild(inpDef);
        tr.appendChild(tdPwdDef);

        // R√©initialiser
        const tdReset = document.createElement("td");
        const btnReset = document.createElement("button");
        btnReset.className = "btn";
        btnReset.style.padding = "3px 6px";
        btnReset.textContent = "R√©initialiser";
        btnReset.addEventListener("click", () => {
          agentPasswords[agent] = agentPasswordDefaults[agent] || "0000";
          savePasswords();
          alert("Mot de passe de " + agent + " r√©initialis√©.");
        });
        tdReset.appendChild(btnReset);
        tr.appendChild(tdReset);

        table.appendChild(tr);
      });
    }

    function buildInterdictionsTable() {
      const table = document.getElementById("table-interdictions");
      table.innerHTML = `
        <tr>
          <th>Date</th>
          <th>√âquipe</th>
          <th>Type</th>
          <th>Note (si "Autre")</th>
          <th>Supprimer</th>
        </tr>
      `;

      interdictions.forEach((it, index) => {
        const tr = document.createElement("tr");

        // Date (input type="date" avec ic√¥ne calendrier)
        const tdDate = document.createElement("td");
        const inpDate = document.createElement("input");
        inpDate.type = "date";
        inpDate.value = it.date || "";
        inpDate.className = "small-input";
        inpDate.addEventListener("change", () => {
          if (!inpDate.value) {
            alert("Date invalide.");
            inpDate.value = it.date;
            return;
          }
          it.date = inpDate.value;
          saveInterdictions();
          buildMonth(currentYear, currentMonthIndex);
        });
        tdDate.appendChild(inpDate);
        tr.appendChild(tdDate);

        // √âquipe
        const tdTeam = document.createElement("td");
        const selTeam = document.createElement("select");
        ["1", "2", "TOUS"].forEach(v => {
          const o = document.createElement("option");
          o.value = v;
          o.textContent = v === "TOUS" ? "TOUS" : "√âquipe " + v;
          selTeam.appendChild(o);
        });
        selTeam.value = it.team;
        selTeam.addEventListener("change", () => {
          it.team = selTeam.value;
          saveInterdictions();
          buildMonth(currentYear, currentMonthIndex);
        });
        tdTeam.appendChild(selTeam);
        tr.appendChild(tdTeam);

        // Type
        const tdType = document.createElement("td");
        const selType = document.createElement("select");
        [
          { value: "EQ1", label: "Man≈ìuvre √âquipe 1" },
          { value: "EQ2", label: "Man≈ìuvre √âquipe 2" },
          { value: "COMMUNE", label: "Man≈ìuvre Commune" },
          { value: "AUTRE", label: "Autre" }
        ].forEach(def => {
          const o = document.createElement("option");
          o.value = def.value;
          o.textContent = def.label;
          selType.appendChild(o);
        });
        selType.value = it.noteType || "EQ1";
        selType.addEventListener("change", () => {
          it.noteType = selType.value;
          saveInterdictions();
          refreshNoteVisibility();
          buildMonth(currentYear, currentMonthIndex);
        });
        tdType.appendChild(selType);
        tr.appendChild(tdType);

        // Note
        const tdNote = document.createElement("td");
        const inpNote = document.createElement("input");
        inpNote.type = "text";
        inpNote.value = it.customNote || "";
        inpNote.className = "full-input";

        function refreshNoteVisibility() {
          inpNote.style.display =
            selType.value === "AUTRE" ? "inline-block" : "none";
        }
        refreshNoteVisibility();

        inpNote.addEventListener("change", () => {
          it.customNote = inpNote.value;
          saveInterdictions();
        });

        tdNote.appendChild(inpNote);
        tr.appendChild(tdNote);

        // Supprimer
        const tdDel = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.className = "btn";
        btnDel.style.padding = "3px 6px";
        btnDel.textContent = "X";
        btnDel.addEventListener("click", () => {
          interdictions.splice(index, 1);
          saveInterdictions();
          buildInterdictionsTable();

